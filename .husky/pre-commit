#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Starting AI Commit Rules Process..."

# Check if there are staged files
if ! git diff --cached --quiet; then
  echo "ğŸ”„ Staged files detected, running commit rules workflow..."

  # 1. Generate Sanity types
  echo "ğŸ“ Step 1: Generating Sanity types..."
  if ! pnpm run typegen; then
    echo "âŒ Sanity type generation failed"
    exit 1
  fi

  # 2. Add generated types to staging if they were updated
  if git diff --quiet sanity.types.ts 2>/dev/null || git diff --quiet src/sanity/types.ts 2>/dev/null; then
    echo "âœ… Sanity types updated, adding to staging..."
    git add sanity.types.ts src/sanity/types.ts 2>/dev/null || true
  fi

  # 3. Validate markdown files
  echo "ğŸ“ Step 2: Validating markdown files..."
  if ! pnpm run validate:md; then
    echo "âŒ Markdown validation failed"
    exit 1
  fi

  # 4. Check plan progress
  echo "ğŸ“Š Step 3: Checking plan progress..."
  if ! pnpm run check:plan; then
    echo "âŒ Plan progress check failed"
    exit 1
  fi

  # 5. Update documentation
  echo "ğŸ“‹ Step 4: Updating documentation..."
  if ! pnpm run update:docs; then
    echo "âŒ Documentation update failed"
    exit 1
  fi

  # 6. Add updated documentation to staging
  git add *.md 2>/dev/null || true
  git add package.json 2>/dev/null || true

  # 7. Format all files
  echo "ğŸ¨ Step 5: Formatting files..."
  if ! pnpm run format; then
    echo "âŒ Formatting failed"
    exit 1
  fi

  # 8. Add formatted files to staging
  git add .

  # 9. Run linting
  echo "ğŸ” Step 6: Running lint check..."
  if ! pnpm run lint:check; then
    echo "âŒ Linting failed"
    exit 1
  fi

  # 10. Build validation
  echo "ğŸ—ï¸ Step 7: Running build validation..."
  if ! pnpm run build; then
    echo "âŒ Build failed"
    exit 1
  fi

  echo "âœ… All commit rules passed successfully!"
else
  echo "â„¹ï¸  No staged files, skipping commit rules workflow"
fi